{% extends 'product_app/base.html' %}

{% load static %}

{% load mathfilters %}

{% block content %}
<!-- Total revenue -->
<h5>Chiffre d'affaire: {{ total_revenue }}</h5>
<!---->
<!-- total by product-->
{% if total_revenue != 0 %}
    <!-- Table -->
    <div class="table-responsive-md">
        <table class="table table-hover table-bordered table-sm table-dark text-center">
            <!-- Table header -->
            <thead>
                <tr class="bg-secondary">
                     <!-- col name -->
                    <th scope="col">Produit</th>
                    <!---->
                    <!-- col quantity -->
                    <th scope="col">Quantité</th>
                    <!-- -->
                    <!-- col total gain -->
                    <th scope="col">Gain</th>
                    <!-- -->
                    <!-- col percent gain with revenue-->
                    <th scope="col">% du CA</th>
                    <!-- -->
                </tr>
            </thead>
            <!---->
            <!-- Table lines -->
            <tbody>
                {% for key, value in total_by_products.items %}
                    <!-- line for each product -->
                    <tr>
                        <!-- name -->
                        <td style="vertical-align: middle;">
                            {{ key.name }}
                        </td>
                        <!---->
                        <!-- quantity -->
                        <td style="vertical-align: middle;">
                            {{ value.0 }} {{ key.unit }}
                        </td>
                        <!---->
                        <!-- gain -->
                        <td style="vertical-align: middle;">
                            {{ value.1 }}
                        </td>
                        <!---->
                        <!-- percent gain with revenue -->
                        <td style="vertical-align: middle;">
                            {{ 100|mul:value.1|div:total_revenue|floatformat:"-2" }} %
                        </td>
                        <!---->
                    </tr>
                {% endfor %}
            </tbody>
            <!---->
        </table>
    </div>
    <!---->
{% endif %}
<!---->
<hr style="border-top: 2px solid #8c8b8b;">
<hr style="border-top: 2px solid #8c8b8b;">
<!---->
<!-- Costs -->
<h5 class="mt-3">Total des coûts{% if total_costs != 0 %}: {{ total_costs  }} soit {{ 100|mul:total_costs|div:total_revenue|floatformat:"-2" }} % du chiffre d'affaire{% endif %}</h5>
<hr style="border-top: 2px solid #8c8b8b;">
<!-- General cost -->
<!-- total for general costs -->
<h5 class="mt-3">Coûts généraux{% if total_general_costs != 0 %}: {{ total_general_costs }} soit {{ 100|mul:total_general_costs|div:total_costs|floatformat:"-2" }} % des coûts / {{ 100|mul:total_general_costs|div:total_revenue|floatformat:"-2" }} % du chiffre d'affaire{% endif %}</h5>
<!---->
<!---->
<!-- Tables general costs  -->
{% for category in general_categories %}
    <div class="table-responsive-md">
        <table class="table table-hover table-bordered table-sm table-dark text-center">
            <!-- Table header -->
            <thead>
                <tr class="bg-secondary">
                    <!-- col cost's name with category's name in header-->
                    <th scope="col" rowspan='2' style="vertical-align: middle;"><strong>{{ category.name }}</strong></th>
                    <!---->
                    <!-- col quantity -->
                    <th scope="col" rowspan='2' style="vertical-align: middle;">Quantité</th>
                    <!-- -->
                    <!-- col amount -->
                    <th scope="col" rowspan='2' style="vertical-align: middle;">Coût</th>
                    <!---->
                    <!-- 3 cols costs % -->
                    <th colspan="3" style="vertical-align: middle;">% des coûts</th>
                    <!---->
                    <!-- col total revenue % -->
                    <th scope="col" rowspan='2' style="vertical-align: middle;">% du CA</th>
                    <!---->
                </tr>
                <tr class="bg-secondary">
                    <th scope="col">{{ category.name }}</th>
                    <th scope="col">généraux</th>
                    <th scope="col">total</th>
                </tr>
            </thead>
            <!---->
            <!-- Table lines -->
            <tbody>
                {% for cost in general_costs %}
                    {% if cost.category == category %}
                        <!-- line for each cost -->
                        <tr>
                            <!-- name -->
                            <td style="vertical-align: middle;">
                                {{ cost.name }}
                            </td>
                            <!---->
                            {% for cost_id, quantity in general_cost_quantities.items %}
                                {% if cost_id == cost.id %}
                                    <!-- quantity -->
                                    <td style="vertical-align: middle;">
                                        {% if quantity != 0 %}
                                            {{ quantity }} {{ cost.unit }}
                                        {% endif %}
                                        <a href="{% url 'calcul' %}ajouter-couts-generaux/{{ cost.id }}/" class="btn btn-sm btn-outline-light">ajouter / historique</a>
                                    </td>
                                    <!-- amount -->
                                    <td style="vertical-align: middle;">
                                        {% if quantity != 0 %}
                                            {{ cost.amount|mul:quantity }}
                                        {% endif %}
                                    </td>
                                    <!---->
                                    <!-- category costs % -->
                                    {% for category_id, total in totals_by_general_category.items %}
                                        {% if category_id == category.id %}
                                            <td style="vertical-align: middle;">
                                                {% if quantity != 0 %}
                                                    {{ 100|mul:cost.amount|mul:quantity|div:total|floatformat:"-2" }} %
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                    <!---->
                                    <!-- general costs % -->
                                    <td style="vertical-align: middle;">
                                        {% if quantity != 0 %}
                                            {{ 100|mul:cost.amount|mul:quantity|div:total_general_costs|floatformat:"-2" }} %
                                        {% endif %}
                                    </td>
                                    <!---->
                                    <!-- total costs % -->
                                    <td style="vertical-align: middle;">
                                        {% if quantity != 0 %}
                                            {{ 100|mul:cost.amount|mul:quantity|div:total_costs|floatformat:"-2" }} %
                                        {% endif %}
                                    </td>
                                    <!---->
                                    <!-- total revenue % -->
                                    <td style="vertical-align: middle;">
                                        {% if quantity != 0 %}
                                            {{ 100|mul:cost.amount|mul:quantity|div:total_revenue|floatformat:"-2" }} %
                                        {% endif %}
                                    </td>
                                    <!---->
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endif %}
                {% endfor %}
                <!-- last line -->
                <tr class="bg-success">
                    <!-- titlte line -->
                    <td colspan="2" class="text-right" style="vertical-align: middle;">
                        Total:
                    </td>
                    <!---->
                    {% for category_id, total in totals_by_general_category.items %}
                        {% if category_id == category.id %}
                            <!-- total cost for category -->
                            <td style="vertical-align: middle;">
                                {% if total != 0 %}
                                    {{ total }}
                                {% endif %}
                            </td>
                            <!---->
                            <td></td>
                            <!-- general costs % -->
                            <td style="vertical-align: middle;">
                                {% if total != 0 %}
                                    {{ 100|mul:total|div:total_general_costs|floatformat:"-2" }} %
                                {% endif %}
                            </td>
                            <!---->
                            <!-- total costs % -->
                            <td style="vertical-align: middle;">
                                {% if total != 0 %}
                                    {{ 100|mul:total|div:total_costs|floatformat:"-2" }} %
                                {% endif %}
                            </td>
                            <!---->
                            <!-- total revenue % -->
                            <td style="vertical-align: middle;">
                                {% if total != 0 %}
                                    {{ 100|mul:total|div:total_revenue|floatformat:"-2" }} %
                                {% endif %}
                            </td>
                            <!---->
                        {% endif %}
                    {% endfor %}
                </tr>
            </tbody>
            <!---->
        </table>
    </div>
    <!---->
{% endfor %}
<!---->
<!---->
<hr style="border-top: 1.5px solid #8c8b8b;">
<!---->
<!-- Cost per product-->
<!-- total for cost per products -->
<h5 class="mt-3">Coûts par produit{% if total_costs_product != 0 %}: {{ total_costs_product }} soit {{ 100|mul:total_costs_product|div:total_costs|floatformat:"-2" }} % des coûts / {{ 100|mul:total_costs_product|div:total_revenue|floatformat:"-2" }} % du chiffre d'affaire{% endif %}</h5>
<!-- Table -->
<div class="table-responsive-md">
    <table class="table table-hover table-bordered table-sm table-dark text-center">
        <!-- Table header -->
        <thead>
            <tr class="bg-secondary">
                <!-- col name -->
                <th scope="col">Produit</th>
                <!---->
                <!-- col total cost -->
                <th scope="col">Total des coûts</th>
                <!-- -->
                <!-- col percent cost with revenue-->
                <th scope="col">% du CA</th>
                <!-- -->
            </tr>
        </thead>
        <!---->
        <!-- Table lines -->
        <tbody>
            {% for product in products %}
                <!-- line for each product -->
                <tr>
                    <!-- name -->
                    <td style="vertical-align: middle;">
                        {{ product.name }} <a href="{% url 'calcul' %}couts-par-produit/{{ product.id }}/" class="btn btn-sm btn-outline-light">détail des coûts</a>
                    </td>
                    <!---->
                    {% for key, value in total_cost_by_product.items %}
                        {% if key == product.id %}
                            <!-- total costs -->
                            <td style="vertical-align: middle;">
                                {% if value != 0 %}
                                    {{ value }}
                                {% endif %}
                            </td>
                            <!---->
                            <!-- percent cost with revenue -->
                            <td style="vertical-align: middle;">
                                {% if value != 0 %}
                                    {{ 100|mul:value|div:total_revenue|floatformat:"-2" }} %
                                {% endif %}
                                
                            </td>
                            <!---->
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
        <!---->
    </table>
</div>
<!---->
<!---->
{% endblock %}
